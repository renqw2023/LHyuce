# 开发日志 - 智能策略分析平台功能迭代与问题修复

**日期:** 2025年11月17日

**概述:**
本次开发会话主要围绕智能策略分析平台的功能增强和现有问题的修复展开。我们增加了新的复盘指标，引入了预测历史功能，并解决了在开发过程中出现的一系列错误，旨在提升平台的用户体验和数据展示的健壮性。

---

## 1. 问题修复与健壮性增强

### Bug 1: `TypeError` 和 `UnicodeDecodeError` (执行中心)

*   **问题描述:** 在“执行中心”运行“每日分析”或“策略优化”时，`subprocess.run` 调用可能因未正确捕获输出或输出包含非 UTF-8 字符而导致 `TypeError` (当 `stdout`/`stderr` 为 `NoneType` 时) 和 `UnicodeDecodeError`。
*   **解决方案:** 修改 `dashboard.py` 中所有 `subprocess.run` 调用，确保 `capture_output=True`，并移除 `text=True`。然后，手动使用 `stdout.decode('utf-8', errors='replace')` 和 `stderr.decode('utf-8', errors='replace')` 对输出进行解码，以避免编码错误并确保输出始终为字符串类型。

### Bug 2: “复盘中心”数据未及时更新 (Streamlit 缓存问题)

*   **问题描述:** 尽管 `run_daily_analysis.py` 脚本在后台成功更新了 `review_log.json` 文件，但 Streamlit 应用的“复盘中心”页面由于 `@st.cache_data` 装饰器的缓存机制，未能及时显示最新的数据。
*   **解决方案:** 在 `dashboard.py` 中，在“执行中心”的“运行每日分析”和“运行策略优化”任务成功完成后，增加了 `st.cache_data.clear()` 和 `st.rerun()` 调用。这强制清除了 Streamlit 的数据缓存并重新运行应用，确保页面显示最新数据。

### Bug 3: `KeyError: 'hits'` (复盘中心)

*   **问题描述:** 在 `dashboard.py` 的 `render_review_center` 函数中，计算热门号码和组合命中率时，代码错误地尝试访问 `item['hits']['hot_numbers']`，而 `item` 本身就是包含命中信息的字典，导致 `KeyError: 'hits'`。
*   **解决方案:** 修正了 `dashboard.py` 中相关代码，将 `item['hits']['hot_numbers']` 改为 `item['hot_numbers']`，`item['hits']['combo_3_in_3']` 改为 `item['combo_3_in_3']`，直接访问字典中的键。

### Bug 4: `KeyError: 'zodiacs'` 和 `KeyError: 'predicted_zodiacs'` (复盘中心)

*   **问题描述:** 在引入生肖和2中2准确率复盘功能后，由于 `review_log.json` 中存在旧的复盘记录，这些记录没有包含新的 `'zodiacs'` 或 `'predicted_zodiacs'` 字段，导致 `dashboard.py` 在尝试访问这些字段时抛出 `KeyError`。
*   **解决方案:**
    *   在 `dashboard.py` 中，所有访问 `hits` 字典中 `'zodiacs'` 和 `'combo_2_in_2'` 键的地方，都改用 `.get('key', 0)` 方法，以在键不存在时返回默认值 `0`。
    *   在 `render_review_center` 函数中，创建 DataFrame 之后，增加了对 `predicted_zodiacs`、`actual_zodiacs` 和 `predicted_combos_3` 列的显式检查和初始化。如果这些列不存在，则会用空列表 `[]` 填充，确保 DataFrame 结构完整。

---

## 2. 功能增强

### 增强 1: “复盘中心”增加生肖准确率和2中2准确率复盘

*   **需求:** 用户希望在“复盘中心”查看生肖预测的准确率和“2中2”组合的命中率。
*   **解决方案:**
    *   **`run_daily_analysis.py` 修改:** 增加了从最新开奖结果中提取实际开奖生肖的逻辑，并计算预测生肖的命中数量。复盘记录 (`review_log.json`) 中新增了 `predicted_zodiacs` (预测生肖列表), `actual_zodiacs` (实际开奖生肖列表) 和 `hits['zodiacs']` (生肖命中数量)。
    *   **`dashboard.py` 修改:**
        *   **总体表现摘要:** 增加了“生肖命中率”和“2中2组合命中率”的统计指标。
        *   **详细复盘日志:** 在每个复盘记录中，增加了“实际开奖生肖”的显示，以及“热门生肖预测”和“'2中2' 组合预测”部分，并显示其命中情况。

### 增强 2: 增加“预测历史”功能

*   **需求:** 用户需要一个功能来记录和查看每一期的预测结果，方便手动复查，该功能需同时支持香港和澳门彩票。
*   **解决方案:**
    *   **预测结果存储:** 修改了 `advanced_lottery_analysis.py` 和 `advanced_hk_analysis.py`。现在，在生成预测结果后，其原始数据（包括期号、热门生肖、热门号码、2中2组合、3中3组合）会被追加到各自的预测历史文件 (`macau_prediction_history.json` 和 `hk_prediction_history.json`) 中。程序会检查重复，避免同一期号的预测被重复记录。
    *   **`dashboard.py` 更新:**
        *   **导航菜单:** 在侧边栏导航中增加了“预测历史”选项。
        *   **新页面:** 创建了 `render_prediction_history` 函数，用于加载并以用户友好的格式显示选定彩票类型（澳门或香港）的所有历史预测记录。

### 增强 3: “总览看板”显示澳门策略学习曲线

*   **需求:** 用户发现“总览看板”中只显示了香港策略的学习曲线，希望也能看到澳门策略的学习曲线。
*   **解决方案:** 在 `dashboard.py` 的“总览看板”页面，在香港策略学习曲线的下方，增加了显示澳门策略学习曲线的代码，确保两个彩票类型的学习曲线都能被展示。

---

## 3. 后续操作建议

*   请用户**重新运行一次“每日分析”**，以确保所有新的功能（特别是预测历史和复盘中心的新指标）能够生成并显示最新的数据。
*   在 Streamlit 应用中，检查“复盘中心”和“预测历史”页面，确认所有功能均按预期工作。

---

**本次开发极大地提升了平台的数据展示能力和用户体验。**

## 2025年11月20日 - 实施“特码独立分析策略”

**概述:**
根据《优化方案2.md》文档，对系统进行了架构级重构，引入了“特码独立分析策略”，旨在精准命中第7个特码和生肖。这包括数据层、算法层、优化层和展示层的全面调整。

**详细变更:**

1.  **数据层 (`advanced_lottery_analysis.py`, `advanced_hk_analysis.py`):**
    *   新增 `load_special_number_data` 函数，专门从历史数据中提取特码（第7个号码）及其生肖、波色、五行信息。
    *   修改 `if __name__ == "__main__":` 块，使其支持通过 `--prediction_type` 参数（`general` 或 `special`）生成通用预测和特码预测。
    *   通用预测结果保存至 `_analysis_results.json` 和 `_prediction_history.json`。
    *   特码预测结果保存至 `_special_analysis_results.json` 和 `_special_prediction_history.json`。

2.  **算法层 (`advanced_lottery_analysis.py`, `advanced_hk_analysis.py`):**
    *   新增 `analyze_special_trend` 函数，实现了特码专用的分析逻辑，重点关注生肖遗漏、热度等维度。

3.  **优化层 (`backtester.py`, `optimizer_special.py`):**
    *   在 `backtester.py` 中新增 `run_special_backtest` 函数，用于特码策略的独立回测，其适应度分数仅由特码生肖命中率决定。
    *   创建了新的优化脚本 `optimizer_special.py`，它是 `optimizer.py` 的特码专用版本，使用 `run_special_backtest` 进行适应度评估，并针对特码相关的权重参数进行优化。

4.  **自动化流程 (`run_daily_analysis.py`):**
    *   修改 `main` 函数，使其在每日分析流程中同时运行通用策略优化 (`optimizer.py`) 和特码策略优化 (`optimizer_special.py`)。
    *   更新 `generate_new_prediction` 函数，使其为每个彩票类型同时生成通用预测和特码预测。
    *   重构 `perform_review` 函数，使其能够加载并对比通用预测和特码预测与实际开奖结果，并将详细的复盘数据（包含通用和特码两部分）记录到 `review_log.json` 中。

5.  **展示层 (`dashboard.py`):**
    *   更新 `render_kpis` 函数，以显示通用策略和特码策略的AI得分及回顾期。
    *   更新 `render_analysis_results` 函数，在“澳门分析”和“香港分析”页面中分别展示通用分析结果和特码狙击结果。
    *   更新 `render_review_center` 函数，以展示更详细的复盘日志，包括通用预测和特码预测的命中情况，并更新了总体表现摘要的KPIs。
    *   更新 `render_prediction_history` 函数，使其能够分别展示通用预测历史和特码预测历史。
    *   更新 `render_learning_curve` 函数，使其能够分别展示通用策略和特码策略的学习曲线。
    *   更新 `create_execution_tab` 函数，在“执行中心”中增加了“运行通用策略优化”和“运行特码策略优化”两个独立的按钮。
    *   更新“总览看板”页面，以使用增强后的学习曲线展示。

**后续操作建议:**
*   建议用户运行一次“每日分析”以生成新的预测和复盘记录。
*   建议用户运行一次“通用策略优化”和“特码策略优化”以生成新的最优策略文件。
---

## 2025-11-20: AI 核心算法升级与 Bug 修复

本次更新是系统的一次重磅升级，严格遵循了《优化方案3》的指导，并修复了后续发现的几个关键问题。

### 一、核心算法重大升级 (V3)

根据《优化方案3》，对 AI 的分析、优化和回测三大核心进行了深度改造，目标是提升预测的精准度。

1.  **特码狙击系统 (调整A)**:
    *   **新增分析维度**: 特码分析不再局限于生肖，现已引入 **“波色”** 和 **“尾数”** 两大关键维度，力求从生肖范围中筛选出1-2个最有可能的号码。
    *   **AI基因进化**: `optimizer_special.py` 已加入 `special_color_weight` 和 `special_tail_weight` 两个新基因，AI现在可以学习如何利用波色和尾数。
    *   **回测激励调整**: `backtester.py` 的特码回测评分机制已修改，猜中生肖得50分，**猜中具体号码得500分**，以此激励AI学习更精准的命中策略。

2.  **正码组合优化 (调整B)**:
    *   **引入“共现矩阵”**: `advanced_analysis` 函数现在会分析历史上所有号码的“搭档”关系。
    *   **组合评分升级**: 在计算“2中2”组合时，会为那些历史上经常一起出现的号码对（“死党”号码）提供**额外加分**，提高了组合预测的逻辑性。
    *   **AI基因进化**: `optimizer.py` 已加入 `co_occurrence_weight` 基因，AI现在可以学习如何利用号码的共现关系。

3.  **复盘惩罚机制 (调整C)**:
    *   **引入“痛感”**: `backtester.py` 的通用回测逻辑增加了一个惩罚项。如果AI推荐的10个热门号码连2个真实中奖号都未能覆盖，**将被扣除50分**。
    *   **策略引导**: 此举旨在强迫AI在追求高分的同时，必须保证推荐结果具备最基本的“防守能力”，避免出现全盘皆错的尴尬情况。

### 二、Bug 修复与体验优化

1.  **修复“复盘中心”数据显示为0的问题**:
    *   **问题定位**: 发现 `run_daily_analysis.py` 在复盘特码时，因代码未同步更新，使用了错误的键名 (`special_zodiacs` 而非 `top_zodiacs`) 读取预测文件，导致无法计算特码命中率。
    *   **解决方案**: 已修正 `perform_review` 函数中的键名，确保复盘时能正确解析所有预测数据。下次运行时，复盘数据将正确记录。

2.  **修复分析脚本输出信息不全的问题**:
    *   **问题定位**: 用户反馈分析过程中未显示期号，且预测的波色是数字而非中文名。
    *   **解决方案**:
        *   修改了 `advanced_..._analysis.py` 脚本，运行时会明确打印正在分析的期号。
        *   重写了 `load_special_number_data` 函数，强制从号码反查颜色名称，确保数据源污染不会影响显示结果。
        *   现在生成的分析报告JSON文件中也会包含期号信息。

### 三、系统状态

*   所有代码已根据上述更新完成修改。
*   旧的AI策略文件已清除，并通过 `run_daily_analysis.py` 完成了**全量再训练**，系统已部署了基于新算法的全新策略。